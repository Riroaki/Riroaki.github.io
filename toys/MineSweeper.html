<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>Mine Sweeper</title>
</head>
<body>

<div class="container" style="text-align: center;">
    <h1>Mine Sweeper!</h1>

    <label>
        <input about='Rows' id='rows_input' value='10' type='number'>
        <br/>
    </label>

    <label>
        <input about='Cols' id='cols_input' value='10' type='number'>
        <br/>
    </label>

    <button onclick='start();' style='width: 100px; height: 40px'>START!
    </button>
    <br/>

    <label id='gameState'>Game State: -</label>
    <br/>
    <label id='remain'>Remain: -</label>

    <div id='board'>
        <!--    Place buttons game board.-->
    </div>
</div>

</body>

<script>
    const UNKWOWN = -1, MARKED = 0, KNOWN = 1;
    const MINE = -1, MINE_RATE = 0.15;
    const RUNNING = 0, LOSE = -1, WIN = 1;
    let map = [], mask = [], init = true, rows = 0, cols = 0, mines = 0,
        remain = 0, gameState = 0;

    function start() {
        gameState = RUNNING;
        rows = parseInt(document.getElementById('rows_input').value);
        cols = parseInt(document.getElementById('cols_input').value);
        remain = rows * cols;
        updateState();
        // Initialize map and mask
        mines = Math.floor(rows * cols * MINE_RATE);
        map = new Array(rows);
        mask = new Array(rows);
        for (let k = 0; k < rows; k++) {
            map[k] = new Array(cols).fill(0);
            mask[k] = new Array(rows).fill(UNKWOWN);
        }
        // Insert buttons in board
        let borad = document.getElementById('board');
        if (isNaN(rows) || isNaN(cols) || rows <= 0 || cols <= 0)
            alert('Invalid shape: ' + rows + ' * ' + cols);
        else {
            // Create game borad
            let board_html = '';
            for (let row = 0; row < rows; row++) {
                let line = '';
                for (let col = 0; col < cols; col++) {
                    let button = ('<button onclick="clickCell({r}, {c})" id="{r}_{c}"' +
                        ' style="display: inline; height: 50px; width: 50px; font-size: 25px;">&nbsp;</button>')
                        .replace(/{r}/g, row.toString())
                        .replace(/{c}/g, col.toString());
                    line += button;
                }
                line = '<div>' + line + '</div>';
                board_html += line;
            }
            borad.innerHTML = board_html;
        }
    }

    function clickCell(i, j) {
        // Check game state
        if (gameState !== RUNNING) {
            alert('Game is over, please restart.')
        } else {
            // Initialize data at first click
            if (init) {
                initData(i, j);
                init = false;
            }
            // Uncover unknown cells
            if (mask[i][j] === UNKWOWN)
                uncover(i, j);
            updateState();
            // Finish game
            if (gameState !== RUNNING)
                endGame();
        }
    }

    function uncover(i, j) {
        // Expand in 4 directions
        const direct = [[1, 0], [-1, 0], [0, 1], [0, -1]];
        updateBoard(i, j);
        if (remain === mines)
            gameState = WIN;
        else if (map[i][j] === MINE)
            gameState = LOSE;
        else if (map[i][j] === 0) {
            // Expand in 4 directions
            for (let k = 0; k < 4; k++) {
                let currRow = i + direct[k][0],
                    currCol = j + direct[k][1];
                if (currRow >= 0 && currRow < rows
                    && currCol >= 0 && currCol < cols
                    && mask[currRow][currCol] === UNKWOWN
                    && map[currRow][currCol] !== MINE)
                    uncover(currRow, currCol);
            }
        }
    }

    function initData(i, j) {
        // Set mines
        console.log(i, j);
        for (let k = 0; k < mines; k++) {
            let randRow = 0, randCol = 0;
            do {
                randRow = Math.floor(Math.random() * rows);
                randCol = Math.floor(Math.random() * cols);
            } while ((randRow === i && randRow === j) || map[randRow][randCol] === MINE);
            console.log(randRow, randCol);
            map[randRow][randCol] = MINE;
        }
        // Set values of cells around mines
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                if (map[row][col] !== MINE) {
                    for (let currRow = Math.max(0, row - 1);
                         currRow < Math.min(rows, row + 2); currRow++) {
                        for (let currCol = Math.max(0, col - 1);
                             currCol < Math.min(cols, col + 2); currCol++) {
                            if (currRow !== row || currCol !== col) {
                                if (map[currRow][currCol] === MINE)
                                    map[row][col]++;
                            }
                        }
                    }
                }
            }
        }
    }

    function endGame() {
        init = true;
        if (gameState === LOSE) {
            // Lose
            for (let row = 0; row < rows; row++)
                for (let col = 0; col < cols; col++)
                    updateBoard(row, col);
            alert('Oops, you lose!');
        } else if (gameState === WIN)
        // Win
            alert('Congratulations, you win!');
    }

    function updateBoard(row, col) {
        if (mask[row][col] === UNKWOWN) {
            let cell = document.getElementById(row + '_' + col);
            if (map[row][col] === MINE) {
                cell.innerText = '*';
                cell.style.color = 'red';
            } else
                cell.innerText = map[row][col].toString();
            mask[row][col] = KNOWN;
            remain -= 1;
        }
    }

    function updateState() {
        let stateString = ['Lose', 'Running', 'Win'][gameState + 1];
        document.getElementById('gameState').innerText = 'Game State: ' + stateString;
        document.getElementById('remain').innerText = 'Remain: ' + remain.toString();
    }
</script>

</html>